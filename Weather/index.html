<html>
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
	<meta name="viewport" content="initial-scale=1.0, user-scalable=no" />
	<style type="text/css">
		body, html,#allmap {width: 100%;height: 100%;overflow: hidden;margin:0;font-family:"微软雅黑";}
	</style>
	<script type="text/javascript" src="http://api.map.baidu.com/api?v=2.0&ak=qjesTeDVm2N2GCISSfOIGogrqquhOkGl"></script>
    <title>根据地区获得气象信息</title>
    <link rel="stylesheet" href="../dist/css/bootstrap.css">
</head>
<body>
    <header>
        <!-- 顶部logo展示 -->
        <div class="container">
            <div class="row">
                <div class="col-12 text-center" style="vertical-align: middle;">
                    <img src="img/weatherLogo.png" style="width:5%; vertical-align:inherit;">
                    <p class="d-inline-block text-info mt-2 ml-2" style="vertical-align:inherit;font-size: 2rem;">气象查询</p>
                </div>
            </div>
        </div>
    </header>
    <!-- 创建查询N天的select -->
    <section>
        <div class="container">
            <div class="row">
                <div class="col-6 text-right">
                    <select class="dropdown col-lg-5 col-md-7 mt-2"  style="vertical-align: middle;"id = "weatherForecastDay">
                        <option class=" source_Language dropdown-item  col-lg-2 col-sm-6 d-inline-block " value="15">未来15天预报</option>
                        <option class=" source_Language dropdown-item  col-lg-2 col-sm-6 d-inline-block " value="7">最近一星期预报</option>
                        <option class=" source_Language dropdown-item  col-lg-2 col-sm-6 d-inline-block " value="24">24小时预报</option>
                    </select>
                </div>
                <!-- 查询按钮 -->
                <div class="col-6 text-left">
                    <button type="button" class="btn btn-primary ml-5 col-lg-5 col-md-7" id="weatherSearchBtn">查询</button>
                </div>
            </div>
            <!-- 提示信息 -->
            <div class="row">
                <p class="text-muted text-center col-12 mt-1" style="font-size: 0.7rem;">地点默认您所在城市...如想更换，请在地图左上角更换地区</p>
            </div>
        </div>
    </section>

    <!-- Echarts jumbotron-fluid-->
    <section>
        <div class="" id="main"></div>
    </section>
    <!-- 地图展示 -->
    <div id="allmap" class="col-12"></div>	
</body>
</html>
<script src="../dist/js/jquery-3.3.1.js"></script>
<script src="../dist/js/popper.js"></script>
<script src="../dist/js/bootstrap.js"></script>
<script src="../dist/js/echarts.js"></script>
<script type="text/javascript">
    // 获得echarts
    var main = document.getElementById("main");
    var myecharts = echarts.init(main, 'light');
    // 定义全局用于存储地点名字
    var place;
	// 百度地图API功能开始*********************************
	var map = new BMap.Map("allmap");
	var point = new BMap.Point(116.331398,39.897445);
	map.centerAndZoom(point,12);
    map.centerAndZoom(point, 14);
    map.enableScrollWheelZoom();
    map.enableInertialDragging();
    map.enableContinuousZoom();
	function myFun(result){
		var cityName = result.name;
        map.setCenter(cityName);
        place = cityName;
		// alert("当前定位城市:"+cityName);
    }
    var size = new BMap.Size(10, 20);
    map.addControl(new BMap.CityListControl({
        anchor: BMAP_ANCHOR_TOP_LEFT,
        offset: size,
        onChangeSuccess: function (e) {
            place = e["title"];
        }
    }));
    var myCity = new BMap.LocalCity();
    myCity.get(myFun);
    // 百度地图API功能结束********************************

    // 查询按钮点击事件开始********************************
    $("#weatherSearchBtn").click(function(){
        // 获取查询天数
        var weatherForecastDay = $("#weatherForecastDay").val();
        // console.log(weatherForecastDay);
        $.ajax({
            url: 'index.php',
            type: 'get',
            data: {"weatherForecastDay":weatherForecastDay,
                    "place":place},
            success: function (res) {
                // 截取从“{”开始直至结束
                var str = res.substring(res.indexOf('{'));
                // 去除字符串中多余空格
                str = str.replace(/\s*/g,"");
                // console.log(str);
                // 将字符串转化为对象
                const strToObj = JSON.parse(str);
                // 将字符串转化为数组
                var arr = []
                    for (let i in strToObj) {
                        let o = {};
                        o[i] = strToObj[i];
                         arr.push(o)
                    }
                // showapi_res_code键位值为0则成功，其他为查询失败
                if(arr[2]["showapi_res_code"] !== 0){
                    alert("查询失败...请重试...");
                }else{
                    // 根据用户查询天数做出相应操作
                    if(weatherForecastDay == 15){
                        // 赋值查询地点
                        var location = arr[3]["showapi_res_body"]["area"];
                        // 赋值当前星期几
                        var weekDay = '星期'+'日一二三四五六'.charAt(new Date().getDay());

                        // 将[dayList]中的数据取出来
                        var dayList = arr[3]["showapi_res_body"]["dayList"];
                        //***********今日天气数据赋值开始*****************************************
                            // 赋值今日天气情况
                            var todayWeather = dayList[1]["day_weather"];
                            // 赋值今日天气logo
                            var todayWeatherLogo = dayList[1]["day_weather_pic"];
                            // 赋值今日白天气温值
                            var todayDayTemperature = dayList[1]["day_air_temperature"];
                            // 赋值今日夜晚气温值
                            var todayNightTemperature = dayList[1]["night_air_temperature"];
                            // 赋值今日风力值
                            var todayWindPower = dayList[1]["day_wind_power"];
                        // ***********今日天气数据赋值结束***********************

                        // 15天的数据赋值开始*****************************************************
                        for (var i = 0; i < dayList.length; i++) {
                            // 赋值半个月的气温值
                            var Half_A_Month_Temperature = dayList[i]["day_air_temperature"];
                            // 赋值半个月的天气logod地址
                            var Half_A_Month_Logo = dayList[i]["day_weather_pic"];
                            // 赋值半个月的的天气情况
                            var Half_A_Month_Weather = dayList[i]["day_weather"];
                        }
                        // 15天的数据赋值结束************************************
                       
                        // myecharts.showLoading();
                        option = {
                            title: {
                                text: '未来一周气温变化',
                                subtext: '纯属虚构'
                            },
                            tooltip: {
                            trigger: 'axis'
                        },
                        legend: {
                            data:['最高气温','最低气温']
                        },
                        toolbox: {
                            show: true,
                            feature: {
                                dataZoom: {
                                    yAxisIndex: 'none'
                                },
                                dataView: {readOnly: false},
                                magicType: {type: ['line', 'bar']},
                                restore: {},
                                saveAsImage: {}
                            }
                        },
                        xAxis:  {
                            type: 'category',
                            boundaryGap: false,
                            data: ['周一','周二','周三','周四','周五','周六','周日']
                        },
                        yAxis: {
                            type: 'value',
                            axisLabel: {
                                formatter: '{value} °C'
                            }
                        },
                        series: [
                            {
                                name:'最高气温',
                                type:'line',
                                data:[11, 11, 15, 13, 12, 13, 10],
                                markPoint: {
                                    data: [
                                        {type: 'max', name: '最大值'},
                                        {type: 'min', name: '最小值'}
                                    ]
                                },
                                markLine: {
                                    data: [
                                        {type: 'average', name: '平均值'}
                                    ]
                                }
                            },
                            {
                                name:'最低气温',
                                type:'line',
                                data:[1, -2, 2, 5, 3, 2, 0],
                                markPoint: {
                                    data: [
                                        {name: '周最低', value: -2, xAxis: 1, yAxis: -1.5}
                                    ]
                                },
                                markLine: {
                                    data: [
                                        {type: 'average', name: '平均值'},
                                        [{
                                            symbol: 'none',
                                            x: '90%',
                                            yAxis: 'max'
                                        }, {
                                            symbol: 'circle',
                                            label: {
                                                normal: {
                                                    position: 'start',
                                                    formatter: '最大值'
                                                }
                                            },
                                            type: 'max',
                                            name: '最高点'
                                        }]
                                    ]
                                }
                            }
                        ]
                    };
                        myecharts.setOption(option);  
                        // console.log(todayWindPower);
                    }
                }
                
            } 
        });
    })
    // 查询按钮点击事件结束********************************
</script>
